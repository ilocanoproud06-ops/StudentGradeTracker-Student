<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - AcademicPro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- React and ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <!-- Local Storage Sync Manager -->
    <script src="firebase-config.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: #f8fafc;
        color: #1e293b;
      }

      .sidebar {
        width: 280px;
        background: #1e293b;
        min-height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 50;
      }

      .main-content {
        margin-left: 280px;
        min-height: 100vh;
      }

      .animate-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;

      // Icons component using Font Awesome
      const Icons = {
        LayoutDashboard: () => <i className="fas fa-th-large"></i>,
        BookOpen: () => <i className="fas fa-book-open"></i>,
        Users: () => <i className="fas fa-users"></i>,
        UserPlus: () => <i className="fas fa-user-plus"></i>,
        FileEdit: () => <i className="fas fa-file-edit"></i>,
        Scale: () => <i className="fas fa-balance-scale"></i>,
        ClipboardList: () => <i className="fas fa-clipboard-list"></i>,
        Trash2: () => <i className="fas fa-trash-alt"></i>,
        Users2: () => <i className="fas fa-user-friends"></i>,
        LogOut: () => <i className="fas fa-sign-out-alt"></i>,
        Plus: () => <i className="fas fa-plus"></i>,
        Pencil: () => <i className="fas fa-pencil-alt"></i>,
        GraduationCap: () => <i className="fas fa-graduation-cap"></i>,
        IdCard: () => <i className="fas fa-id-card"></i>,
        Key: () => <i className="fas fa-key"></i>,
        Target: () => <i className="fas fa-bullseye"></i>,
        ChevronRight: () => <i className="fas fa-chevron-right"></i>,
        Calculator: () => <i className="fas fa-calculator"></i>,
        Calendar: () => <i className="fas fa-calendar-alt"></i>,
        Mail: () => <i className="fas fa-envelope"></i>,
        Clock: () => <i className="fas fa-clock"></i>,
        MapPin: () => <i className="fas fa-map-marker-alt"></i>,
        Laptop: () => <i className="fas fa-laptop"></i>,
        BookText: () => <i className="fas fa-book"></i>,
        Search: () => <i className="fas fa-search"></i>,
        CheckCircle2: () => <i className="fas fa-check-circle"></i>,
        X: () => <i className="fas fa-times"></i>,
        FileText: () => <i className="fas fa-file-alt"></i>,
        Trophy: () => <i className="fas fa-trophy"></i>,
        Percent: () => <i className="fas fa-percent"></i>,
        Table: () => <i className="fas fa-table"></i>,
        Filter: () => <i className="fas fa-filter"></i>,
        Save: () => <i className="fas fa-save"></i>,
        Download: () => <i className="fas fa-download"></i>,
        Edit: () => <i className="fas fa-edit"></i>,
        Eye: () => <i className="fas fa-eye"></i>,
        Refresh: () => <i className="fas fa-sync-alt"></i>,
      };

      // Navigation Item Component
      function NavItem({ icon, label, active, onClick }) {
        return (
          <button
            onClick={onClick}
            className={`w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all group ${active ? "bg-blue-600 text-white shadow-xl shadow-blue-600/30" : "text-slate-400 hover:text-white hover:bg-slate-700/50"}`}
          >
            <span
              className={`${active ? "text-white" : "text-slate-500 group-hover:text-blue-400"} transition-colors`}
            >
              {icon}
            </span>
            <span className="text-sm font-bold tracking-tight">{label}</span>
          </button>
        );
      }

      // Main App Component
      function App() {
        const [activeTab, setActiveTab] = useState("Grade Entry");
        const [selectedCourseId, setSelectedCourseId] = useState(101);
        const [selectedMonth, setSelectedMonth] = useState("February");
        const [store, setStore] = useState(null);
        const [loading, setLoading] = useState(true);

        // Initialize data from SyncManager
        useEffect(() => {
          async function loadData() {
            try {
              const data = await SyncManager.loadData();
              setStore(data);
              console.log("Data loaded:", data);
            } catch (error) {
              console.error("Error loading data:", error);
            } finally {
              setLoading(false);
            }
          }
          loadData();
        }, []);

        // Default data if no store
        const defaultStudents = [
          {
            id: 1,
            studentIdNum: "2024-0001",
            name: "Garcia, Maria S.",
            program: "BSCS",
          },
          {
            id: 2,
            studentIdNum: "2024-0002",
            name: "Wilson, James K.",
            program: "BSIT",
          },
          {
            id: 3,
            studentIdNum: "2024-0003",
            name: "Chen, Robert L.",
            program: "BS MATH",
          },
        ];

        const defaultCourses = [
          { id: 101, title: "Mathematics 101", code: "MATH101" },
          { id: 102, title: "Computer Science", code: "CS202" },
        ];

        const defaultAssessments = [
          {
            id: 501,
            courseId: 101,
            category: "Written Exam",
            title: "Prelim Exam",
            month: "February",
            hps: 100,
          },
          {
            id: 502,
            courseId: 101,
            category: "Written Exam",
            title: "Quiz 1",
            month: "February",
            hps: 50,
          },
          {
            id: 503,
            courseId: 101,
            category: "Performance Task",
            title: "Seatwork",
            month: "February",
            hps: 20,
          },
          {
            id: 504,
            courseId: 102,
            category: "Laboratory",
            title: "Lab 1",
            month: "February",
            hps: 50,
          },
        ];

        const students = store?.students || defaultStudents;
        const courses = store?.courses || defaultCourses;
        const enrollments = store?.enrollments || [];
        const assessments = store?.assessments || defaultAssessments;
        const grades = store?.grades || {};
        const hps = store?.hps || {
          quiz: 50,
          pt: 100,
          project: 100,
          exam: 100,
        };
        const weights = store?.weights || {
          written: 40,
          quiz: 20,
          pt: 30,
          project: 10,
        };

        // Filtered assessments for selected course and month
        const filteredAssessments = useMemo(
          () =>
            assessments.filter(
              (a) =>
                a.courseId === selectedCourseId && a.month === selectedMonth,
            ),
          [assessments, selectedCourseId, selectedMonth],
        );

        // Get students enrolled in selected course
        const studentsInCourse = useMemo(() => {
          const enrolledIds = enrollments
            .filter((e) => e.courseId === selectedCourseId)
            .map((e) => e.studentId);
          if (enrolledIds.length === 0) {
            return students.slice(0, 3);
          }
          return students.filter((s) => enrolledIds.includes(s.id));
        }, [students, enrollments, selectedCourseId]);

        // State for grades
        const [localGrades, setLocalGrades] = useState([
          { id: "g1", studentId: 1, assessmentId: 501, score: 95 },
          { id: "g2", studentId: 2, assessmentId: 501, score: 88 },
        ]);

        // Get grade for a student and assessment
        const getScore = (studentId, assessmentId) => {
          const entry = localGrades.find(
            (g) => g.studentId === studentId && g.assessmentId === assessmentId,
          );
          return entry ? entry.score : "";
        };

        // Update grade
        const updateGrade = (studentId, assessmentId, score) => {
          const val = score === "" ? "" : parseFloat(score);
          setLocalGrades((prev) => {
            const exists = prev.find(
              (g) =>
                g.studentId === studentId && g.assessmentId === assessmentId,
            );
            if (exists) {
              return prev.map((g) =>
                g.studentId === studentId && g.assessmentId === assessmentId
                  ? { ...g, score: val }
                  : g,
              );
            }
            return [
              ...prev,
              { id: `g-${Date.now()}`, studentId, assessmentId, score: val },
            ];
          });
        };

        // Calculate average for a student
        const calculateAverage = (studentId) => {
          let totalEarned = 0;
          let totalHps = 0;

          filteredAssessments.forEach((a) => {
            const score = getScore(studentId, a.id);
            if (score !== "" && score !== null) {
              totalEarned += score;
              totalHps += a.hps;
            }
          });

          return totalHps > 0 ? Math.round((totalEarned / totalHps) * 100) : 0;
        };

        // Get letter grade
        const getLetterGrade = (percentage) => {
          const gradingScale = store?.gradingScale || [
            { min: 95, max: 100, label: "A" },
            { min: 90, max: 94, label: "A-" },
            { min: 85, max: 89, label: "B+" },
            { min: 80, max: 84, label: "B" },
            { min: 75, max: 79, label: "B-" },
            { min: 70, max: 74, label: "C+" },
            { min: 65, max: 69, label: "C" },
            { min: 60, max: 64, label: "C-" },
            { min: 55, max: 59, label: "D" },
            { min: 0, max: 54, label: "F" },
          ];
          return (
            gradingScale.find((s) => percentage >= s.min && percentage <= s.max)
              ?.label || "N/A"
          );
        };

        // Export data
        const handleExport = () => {
          SyncManager.exportData();
        };

        // Render Grade Entry Tab
        const renderExcelGradeEntry = () => (
          <div className="space-y-6 animate-in">
            {/* Header & Course Navigation */}
            <div className="flex flex-col md:flex-row md:items-end justify-between gap-6">
              <div>
                <h2 className="text-2xl font-black text-slate-800 tracking-tight">
                  Grade Entry Spreadsheet
                </h2>
                <p className="text-xs text-slate-400 font-medium uppercase tracking-widest mt-1">
                  Excel-Style Manual Entry Mode
                </p>
              </div>

              <div className="flex items-center gap-3 bg-white p-2 rounded-[24px] shadow-sm border border-slate-200">
                <div className="flex items-center gap-2 px-4 py-2 bg-slate-50 rounded-xl border border-slate-100">
                  <Icons.Filter />
                  <select
                    value={selectedCourseId}
                    onChange={(e) =>
                      setSelectedCourseId(parseInt(e.target.value))
                    }
                    className="bg-transparent text-xs font-black text-slate-700 outline-none"
                  >
                    {courses.map((c) => (
                      <option key={c.id} value={c.id}>
                        {c.code} - {c.title}
                      </option>
                    ))}
                  </select>
                </div>
                <div className="flex items-center gap-2 px-4 py-2 bg-slate-50 rounded-xl border border-slate-100">
                  <Icons.Calendar />
                  <select
                    value={selectedMonth}
                    onChange={(e) => setSelectedMonth(e.target.value)}
                    className="bg-transparent text-xs font-black text-slate-700 outline-none"
                  >
                    {[
                      "January",
                      "February",
                      "March",
                      "April",
                      "May",
                      "June",
                      "July",
                      "August",
                      "September",
                      "October",
                      "November",
                      "December",
                    ].map((m) => (
                      <option key={m} value={m}>
                        {m}
                      </option>
                    ))}
                  </select>
                </div>
              </div>
            </div>

            {/* Spreadsheet Grid */}
            <div className="bg-white rounded-[32px] shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full border-collapse">
                  <thead>
                    <tr className="bg-slate-900 text-white">
                      <th className="sticky left-0 z-10 bg-slate-900 px-8 py-6 text-left border-r border-slate-800 min-w-[280px]">
                        <div className="text-[10px] font-black text-slate-500 uppercase tracking-[2px]">
                          Student Info
                        </div>
                      </th>
                      {filteredAssessments.map((a) => (
                        <th
                          key={a.id}
                          className="px-6 py-6 text-center border-r border-slate-800 min-w-[140px]"
                        >
                          <div className="text-[10px] font-black text-blue-400 uppercase mb-1">
                            {a.category}
                          </div>
                          <div className="text-xs font-black tracking-tight">
                            {a.title}
                          </div>
                          <div className="text-[10px] font-bold text-slate-500 mt-1 italic">
                            HPS: {a.hps}
                          </div>
                        </th>
                      ))}
                      <th className="px-8 py-6 text-center bg-indigo-900/50 min-w-[120px]">
                        <div className="text-[10px] font-black text-indigo-300 uppercase">
                          Average
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {studentsInCourse.map((student, sIdx) => {
                      const avg = calculateAverage(student.id);
                      return (
                        <tr
                          key={student.id}
                          className="group hover:bg-blue-50/30 transition-colors border-b border-slate-100"
                        >
                          <td className="sticky left-0 z-10 bg-white group-hover:bg-blue-50/30 px-8 py-4 border-r border-slate-100 transition-colors">
                            <div className="flex items-center gap-3">
                              <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-[10px] font-black text-slate-500">
                                {sIdx + 1}
                              </div>
                              <div>
                                <div className="text-sm font-bold text-slate-800">
                                  {student.name}
                                </div>
                                <div className="text-[10px] font-black text-slate-400 uppercase">
                                  {student.studentIdNum || student.idNum}
                                </div>
                              </div>
                            </div>
                          </td>
                          {filteredAssessments.map((a) => {
                            const score = getScore(student.id, a.id);
                            return (
                              <td
                                key={a.id}
                                className="px-4 py-3 border-r border-slate-50 text-center"
                              >
                                <input
                                  type="number"
                                  max={a.hps}
                                  value={score}
                                  onChange={(e) =>
                                    updateGrade(
                                      student.id,
                                      a.id,
                                      e.target.value,
                                    )
                                  }
                                  className="w-20 px-3 py-2 bg-slate-50 rounded-xl text-center text-sm font-black text-slate-800 focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all border-2 border-transparent"
                                  placeholder="-"
                                />
                              </td>
                            );
                          })}
                          <td className="px-8 py-4 text-center bg-slate-50/50">
                            <div className="font-black text-indigo-600 text-sm">
                              {avg}%
                              <span className="ml-2 text-xs text-slate-400">
                                {getLetterGrade(avg)}
                              </span>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              {studentsInCourse.length === 0 && (
                <div className="py-20 flex flex-col items-center justify-center bg-slate-50/30">
                  <Icons.Users2 />
                  <p className="text-slate-400 font-bold text-sm mt-4">
                    No students enrolled in this course.
                  </p>
                </div>
              )}

              <div className="p-6 bg-slate-50 border-t border-slate-200 flex justify-between items-center">
                <div className="flex gap-4">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-blue-500 animate-pulse"></div>
                    <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">
                      Auto-Saving Enabled
                    </span>
                  </div>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={handleExport}
                    className="flex items-center gap-2 px-5 py-2.5 bg-white border border-slate-200 rounded-xl text-[10px] font-black text-slate-600 uppercase tracking-widest hover:bg-slate-100 transition-all"
                  >
                    <Icons.Download /> Export CSV
                  </button>
                  <button className="flex items-center gap-2 px-6 py-2.5 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-black shadow-lg transition-all">
                    <Icons.Save /> Finalize Grades
                  </button>
                </div>
              </div>
            </div>
          </div>
        );

        // Loading state
        if (loading) {
          return (
            <div className="flex h-screen items-center justify-center">
              <div className="text-center">
                <div className="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p className="text-slate-600 font-bold">Loading data...</p>
              </div>
            </div>
          );
        }

        return (
          <div className="flex h-screen bg-[#f8fafc] text-slate-800 font-sans overflow-hidden">
            {/* Sidebar */}
            <aside className="sidebar flex flex-col shrink-0 shadow-2xl z-20">
              <div className="p-8 flex items-center gap-4 text-white">
                <div className="bg-blue-500 p-2 rounded-xl shadow-lg shadow-blue-500/30">
                  <Icons.GraduationCap />
                </div>
                <span className="text-xl font-black tracking-tight uppercase">
                  Academic<span className="text-blue-400">Pro</span>
                </span>
              </div>
              <nav className="flex-1 px-4 space-y-2 mt-4 overflow-y-auto">
                <NavItem
                  icon={<Icons.LayoutDashboard />}
                  label="Dashboard"
                  active={activeTab === "Dashboard"}
                  onClick={() => setActiveTab("Dashboard")}
                />
                <NavItem
                  icon={<Icons.Users />}
                  label="Students"
                  active={activeTab === "Students"}
                  onClick={() => setActiveTab("Students")}
                />
                <NavItem
                  icon={<Icons.BookOpen />}
                  label="Courses"
                  active={activeTab === "Courses"}
                  onClick={() => setActiveTab("Courses")}
                />
                <NavItem
                  icon={<Icons.UserPlus />}
                  label="Enrollment"
                  active={activeTab === "Enrollment"}
                  onClick={() => setActiveTab("Enrollment")}
                />
                <div className="pt-8 pb-2 px-4">
                  <span className="text-[10px] font-black text-slate-500 uppercase tracking-[2px]">
                    Grade Portal
                  </span>
                </div>
                <NavItem
                  icon={<Icons.Target />}
                  label="Assessment & HPS"
                  active={activeTab === "Assessment"}
                  onClick={() => setActiveTab("Assessment")}
                />
                <NavItem
                  icon={<Icons.FileEdit />}
                  label="Grade Entry"
                  active={activeTab === "Grade Entry"}
                  onClick={() => setActiveTab("Grade Entry")}
                />
              </nav>
              <div className="p-4 border-t border-slate-700">
                <a
                  href="welcome_admin.html"
                  className="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-700/50 transition-all"
                >
                  <Icons.LogOut />
                  <span className="text-sm font-bold">Sign Out</span>
                </a>
              </div>
            </aside>

            {/* Main Content */}
            <main className="main-content flex flex-col overflow-hidden">
              <header className="h-20 flex items-center justify-between px-10 bg-white border-b border-slate-200/60">
                <div className="flex items-center gap-3 text-slate-400">
                  <span className="font-black text-[10px] tracking-widest uppercase">
                    Admin
                  </span>
                  <Icons.ChevronRight />
                  <span className="text-slate-800 font-bold tracking-tight uppercase tracking-widest text-[10px]">
                    {activeTab}
                  </span>
                </div>
                <div className="flex items-center gap-4">
                  <div className="bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest border border-emerald-100 flex items-center gap-2">
                    <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>{" "}
                    Online
                  </div>
                  <div className="w-10 h-10 rounded-2xl bg-slate-100 flex items-center justify-center font-black">
                    AD
                  </div>
                </div>
              </header>

              <div className="flex-1 overflow-y-auto p-10 bg-slate-50/40">
                {activeTab === "Grade Entry" ? (
                  renderExcelGradeEntry()
                ) : (
                  <div className="p-20 text-center text-slate-300 italic font-black text-2xl uppercase tracking-widest opacity-20">
                    <div className="mb-4">
                      <Icons.LayoutDashboard />
                    </div>
                    Navigation - {activeTab} Coming Soon
                  </div>
                )}
              </div>
            </main>
          </div>
        );
      }

      // Render the app
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
